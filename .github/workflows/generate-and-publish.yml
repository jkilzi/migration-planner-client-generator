# =============================================================================
# Reusable Workflow: Generate and Publish OpenAPI Client
# =============================================================================
# This workflow generates a TypeScript client from an OpenAPI specification
# and publishes it to npm. It can be called from other repositories using
# the workflow_call trigger.
#
# Output: Generated client is placed in the 'generated-client' directory
#
# Authorization: Calls from this repository are automatically authorized.
# External repositories must be listed in .github/allowed_repos.json (source of truth).
#
# Publishing Authentication:
#   Uses npm Trusted Publishing (OIDC) exclusively â€” no long-lived tokens.
#   - Requires id-token: write permission in calling workflow
#   - Requires Trusted Publisher configured on npmjs.com
#   - Calling workflow must use 'secrets: inherit' to pass OIDC permissions
#   - See: https://docs.npmjs.com/trusted-publishers
#
# Local Testing with act-cli:
#   OIDC doesn't work locally, so only dry-run mode is available.
#   Use 'make test' for local testing; actual publish testing should be
#   done in CI where OIDC is available.
#
# Repository: kubev2v/migration-planner-client-generator
# =============================================================================

name: Generate and Publish OpenAPI Client

on:
  workflow_call:
    inputs:
      openapi-spec-url:
        description: 'URL to the OpenAPI specification file'
        required: true
        type: string
      package-name:
        description: 'npm package name (e.g., @scope/package-name)'
        required: true
        type: string
      package-version:
        description: 'Package version to publish (semver)'
        required: true
        type: string
      npm-registry:
        description: 'npm registry URL'
        required: false
        type: string
        default: 'https://registry.npmjs.org'
      dry-run:
        description: 'Skip npm publish (for testing)'
        required: false
        type: boolean
        default: false

jobs:
  # ===========================================================================
  # Job 1: Authorization Check
  # ===========================================================================
  # This repository is automatically authorized (for CI/testing).
  # External repositories must be listed in .github/allowed_repos.json.
  # ===========================================================================
  authorize:
    name: Verify Authorization
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
    steps:
      - name: Verify caller is authorized
        id: check
        env:
          CALLER_REPO: ${{ github.repository }}
          THIS_REPO: "kubev2v/migration-planner-client-generator"
          ALLOWED_REPOS_URL: "https://raw.githubusercontent.com/kubev2v/migration-planner-client-generator/main/.github/allowed_repos.json"
        run: |
          set -e
          # Allow calls from this repository (for CI/testing)
          if [ "$CALLER_REPO" = "$THIS_REPO" ]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "âœ… Repository is authorized (same-repo call)"
            exit 0
          fi
          
          # Fetch allowed repos list (source of truth in this repo)
          ALLOWED_REPOS=$(curl -sL "$ALLOWED_REPOS_URL") || true
          if [ -z "$ALLOWED_REPOS" ]; then
            echo "::error::Failed to fetch .github/allowed_repos.json"
            exit 1
          fi
          
          if ! echo "$ALLOWED_REPOS" | jq empty 2>/dev/null; then
            echo "::error::allowed_repos.json is not valid JSON"
            exit 1
          fi
          
          if echo "$ALLOWED_REPOS" | jq -e --arg repo "$CALLER_REPO" 'index($repo) != null' > /dev/null; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "âœ… Repository is authorized"
          else
            echo "::error::Unauthorized repository attempted to call this workflow"
            exit 1
          fi

  # ===========================================================================
  # Job 2: Generate and Publish
  # ===========================================================================
  generate-and-publish:
    name: Generate & Publish Client
    needs: authorize
    if: needs.authorize.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for npm Trusted Publishing (OIDC)
      contents: read

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Generate the client using OpenAPI Generator
      # -----------------------------------------------------------------------
      - name: Generate OpenAPI Client
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: typescript-fetch
          openapi-url: ${{ inputs.openapi-spec-url }}
          command-args: >-
            -o generated-client
            --additional-properties=npmName=${{ inputs.package-name }},npmVersion=${{ inputs.package-version }},ensureUniqueParams=true,supportsES6=true,withInterfaces=true,importFileExtension=.js

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js environment
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: ${{ inputs.npm-registry }}

      # -----------------------------------------------------------------------
      # Step 3: Configure additional package metadata
      # -----------------------------------------------------------------------
      - name: Configure Package Metadata
        working-directory: generated-client
        run: |
          echo "ðŸ“¦ Adding additional package metadata..."
          npm pkg set license="Apache-2.0"
          npm pkg set repository.type="git"
          npm pkg set repository.url="https://github.com/${{ github.repository }}"
          
          echo "ðŸ“¦ Package configuration:"
          cat package.json | jq '{name, version, license, main, repository}'

      # -----------------------------------------------------------------------
      # Step 4: Install dependencies and build
      # -----------------------------------------------------------------------
      - name: Install & Build
        working-directory: generated-client
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm install
          
          echo "ðŸ”¨ Building package..."
          npm run build --if-present
          
          echo "âœ… Build completed successfully"

      # -----------------------------------------------------------------------
      # Step 5: Publish to npm (unless dry-run)
      # Uses OIDC Trusted Publishing exclusively.
      #
      # Why we overwrite NPM_CONFIG_USERCONFIG:
      #   actions/setup-node with registry-url creates a .npmrc at
      #   $NPM_CONFIG_USERCONFIG containing an _authToken placeholder
      #   (e.g. //<registry>/:_authToken=${NODE_AUTH_TOKEN}).
      #   When NODE_AUTH_TOKEN is unset, npm resolves this to an empty
      #   string and treats it as "auth configured but invalid", failing
      #   with ENEEDAUTH instead of falling through to OIDC.
      #   Overwriting the file with only the registry line strips the
      #   token-based auth so npm proceeds to Trusted Publishing.
      # -----------------------------------------------------------------------
      - name: Publish to npm
        if: ${{ inputs.dry-run != true }}
        working-directory: generated-client
        run: |
          # Strip token auth from .npmrc so npm falls through to OIDC
          echo "registry=${{ inputs.npm-registry }}" > "$NPM_CONFIG_USERCONFIG"
          echo "ðŸš€ Publishing ${{ inputs.package-name }}@${{ inputs.package-version }} to npm..."
          npm publish --access public --provenance
          echo "âœ… Package published successfully!"

      - name: Dry Run Summary
        if: ${{ inputs.dry-run == true }}
        run: |
          echo "ðŸ§ª DRY RUN MODE - Package was NOT published"
          echo ""
          echo "Summary:"
          echo "  Package: ${{ inputs.package-name }}"
          echo "  Version: ${{ inputs.package-version }}"
          echo "  Generator: typescript-fetch"
          echo ""
          echo "To publish for real, re-run without the dry-run flag."

      # -----------------------------------------------------------------------
      # Step 6: Create summary
      # -----------------------------------------------------------------------
      - name: Job Summary
        run: |
          echo "## ðŸ“¦ OpenAPI Client Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package Name | \`${{ inputs.package-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ inputs.package-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Generator | \`typescript-fetch\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry-run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Repo | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
